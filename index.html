<!DOCTYPE html>
<html lang="fr">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Scène A-Frame</title>
   <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
   <script src="https://unpkg.com/aframe-environment-component/dist/aframe-environment-component.min.js"></script>
   <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script>
   <script src="https://cdn.jsdelivr.net/gh/kylebakerio/ada-water/ada-water.js"></script>
   <script src="/water.js"></script>
</head>
<body>
  <a-scene vr-mode-ui="enabled: true">
    <!-- Chargement des ressources -->
    <a-assets>

      <a-assets-item id="db1" src="./assets/Dragon ball/dragon ball 1.glb"></a-assets-item>
      <a-assets-item id="db2" src="./assets/Dragon ball/dragon ball 2.glb"></a-assets-item>
      <a-assets-item id="db3" src="./assets/Dragon ball/dragon ball 3.glb"></a-assets-item>
      <a-assets-item id="db4" src="./assets/Dragon ball/dragon ball 4.glb"></a-assets-item>
      <a-assets-item id="db5" src="./assets/Dragon ball/dragon ball 5.glb"></a-assets-item>
      <a-assets-item id="db6" src="./assets/Dragon ball/dragon ball 6.glb"></a-assets-item>
      <a-assets-item id="db7" src="./assets/Dragon ball/dragon ball 7.glb"></a-assets-item>

      <video id="introdb" src="./assets/Intro1.mp4" autoplay playsinline></video>

      <a-asset-item id="kamehouse-glb" src="./assets/Kame V8.glb"></a-asset-item>
      <a-asset-item id="nimbus-glb" src="./assets/nimbus.glb"></a-asset-item>
      <a-asset-item id="ile-glb" src="./assets/IleV8.glb"></a-asset-item>
      <a-asset-item id="palmier-glb" src="./assets/Palmier.glb"></a-asset-item>
      <a-asset-item id="palmier2-glb" src="./assets/Palmier2.glb"></a-asset-item>
      <a-asset-item id="navmesh" src="./assets/navmesh.glb"></a-asset-item>
      <img id="sky" src="./assets/sky.png" alt="Texture du ciel">
      <audio id="kame-house-sound" src="./assets/Ambient.mp3" preload="auto"></audio>
      <audio id="wave-sound" src="./assets/vagues.mp3"></audio>
    </a-assets>

    <!-- Ciel -->
    <a-sky src="#sky"></a-sky>

    <!-- Eau -->
    <a-water 
      id="water"
      scale="100 100 1" 
      opacity=".6" 
      position="0 -.5 0" 
      side="double" 
      width="10" 
      length="10" 
      base-color="blue" 
      foam-color="lightblue" 
      repeat="10" 
      voronoi-points="15">
    </a-water>   

    <!-- Son, Musique -->
    <a-entity sound="src: #wave-sound; autoplay: true; loop: true; volume: 2"></a-entity>


    <!-- Caméra avec curseur et VR -->
    <a-entity id="rig" movement-controls="fly: true; acceleration: 100; constrainToNavMesh: true" position="2 .6 4" toggle-navmesh rotation="0 180 0">
      <a-entity
        id="camera"
        camera
        position="0 1.6 0"
        look-controls="pointerLockEnabled: true">
        <a-cursor></a-cursor>
        <a-entity id="collect-text" position="-1.375 .75 -1" text="value: Dragon Balls: 0/7; color: white; align: center"></a-entity>
      </a-entity>

      <!-- Contrôleurs VR -->
      <a-entity
        oculus-touch-controls="hand: left"
        laser-controls="hand: left"
        raycaster="objects: .clickable; far: 10; showLine: true">
      </a-entity>
      <a-entity
        oculus-touch-controls="hand: right"
        laser-controls="hand: right"
        raycaster="objects: .clickable; far: 10; showLine: true">
      </a-entity>

    <!-- Nuage -->
      <a-entity id="nimbus" gltf-model="#nimbus-glb" scale="2 2 2" position="0 -2 0" rotation="180 0 0" visible="false"></a-entity>
    </a-entity>

    <!-- Vidéo -->
<a-entity position="5 1.6 9" rotation="0 210   0">


  <a-entity 
    text="value: PAR ICI;" 
    position="2.4 1.7 0" 
    rotation="0 0 0" 
    scale="6 6 6" 
    side="double"
    animation="property: position; from: 2.4 1.7 0; to: 2.4 2 0; dur: 2000; dir: alternate; loop: true"
    show-video-on-approach="distance: 3">
</a-entity>

</a-entity>

  

    <!-- Nuage controller -->
    <a-entity id="nimbus-controller" nimbus-rotation></a-entity>

    <!-- Modèles 3D et lumières -->
    <a-entity 
      gltf-model="#kamehouse-glb" 
      position="0 .6 0" 
      rotation="0 180 0" 
      material="shader: flat"
      sound="src: #kame-house-sound; autoplay: true; loop: true; positional: true; distanceModel: linear; maxDistance: 25">
    </a-entity>    

    <a-entity
      nav-mesh
      visible="false"
      gltf-model="#navmesh" 
      position="0 -.6 0" 
      rotation="0 180 0">
    </a-entity>

    <a-entity>
      <a-entity gltf-model="#ile-glb" position="1.1 -.7 1.1" rotation="0 0 0" material="shader: flat"></a-entity>
      <a-entity gltf-model="#palmier2-glb" position="9 0 0" rotation="0 45 0" material="shader: flat" scale="2 2 2"></a-entity>
      <a-entity gltf-model="#palmier2-glb" position="1.275 -.450 -11.970" rotation="0 120 0" material="shader: flat" scale="2 2 2"></a-entity>
      <a-entity gltf-model="#palmier-glb" position="-4 0 1" rotation="0 170 0" material="shader: flat" scale="2 2 2"></a-entity>
      <a-entity id="db1" gltf-model="#db1" position="12.054 0.953  -9.404" rotation="0 220 0" material="shader: flat" scale=".1 .1 .1" class="collectible clickable"></a-entity>
      <a-entity id="db2" gltf-model="#db2" position="15 -0.352 -6.218" rotation="0 220 0" material="shader: flat" scale=".1 .1 .1" class="collectible clickable"></a-entity>
      <a-entity id="db3" gltf-model="#db3" position="8.712 4.112 1.164" rotation="0 220 0" material="shader: flat" scale=".1 .1 .1" class="collectible clickable"></a-entity>
      <a-entity id="db4" gltf-model="#db4" position="-2.2 0.58 -3" rotation="0 220 0" material="shader: flat" scale=".1 .1 .1" class="collectible clickable"></a-entity>
      <a-entity id="db5" gltf-model="#db5" position=".8 0 -12.218" rotation="0 220 0" material="shader: flat" scale=".1 .1 .1" class="collectible clickable"></a-entity>
      <a-entity id="db6" gltf-model="#db6" position="14.56 -.195 7.596" rotation="0 220 0" material="shader: flat" scale=".1 .1 .1" class="collectible clickable"></a-entity>
      <a-entity id="db7" gltf-model="#db7" position="-3.7 3.8 6.279" rotation="0 220 0" material="shader: flat" scale=".1 .1 .1" class="collectible clickable"></a-entity>
      <a-entity gltf-model="#palmier-glb" position="9 0 0" rotation="0 0 0" material="shader: flat" scale="2 2 2"></a-entity>
    </a-entity>

    <!-- Scripts -->
    <script>
      AFRAME.registerComponent('nimbus-rotation', {
        init: function () {
          this.cameraEl = document.querySelector('#camera');
          this.nimbusEl = document.querySelector('#nimbus');
        },
        tick: function () {
          // Récupérer la position de la caméra
          const cameraPosition = this.cameraEl.object3D.position;
          // Définir la position du Nimbus pour qu'il suive la caméra
          this.nimbusEl.object3D.position.set(cameraPosition.x, cameraPosition.y - 1.6, cameraPosition.z);
          
          // Récupérer la rotation de la caméra
          const cameraRotation = this.cameraEl.object3D.rotation.y;
          // Appliquer la rotation de la caméra au Nimbus
          this.nimbusEl.object3D.rotation.y = cameraRotation;
        }
      });
    </script>


<script>
  AFRAME.registerComponent('toggle-navmesh', {
    init: function () {
      this.navMeshEnabled = true; // Contrainte activée par défaut
      this.rig = document.querySelector('#rig');
      this.collectedBalls = 0;
      this.totalBalls = document.querySelectorAll('.collectible').length;
      this.toggleNavMesh = this.toggleNavMesh.bind(this);

      window.addEventListener('keydown', this.toggleNavMesh);
    },

    toggleNavMesh: function (event) {
      if (event.code === 'Space') {
        // Vérifier si toutes les Dragon Balls sont collectées
        if (this.collectedBalls < this.totalBalls) {
          console.log("Vol non autorisé, il reste des Dragon Balls à collecter.");
          return;
        }

        this.navMeshEnabled = !this.navMeshEnabled;
        
        // Supprimer puis réassigner movement-controls avec la nouvelle contrainte
        this.rig.removeAttribute('movement-controls');
        this.rig.setAttribute('movement-controls', `fly: true; acceleration: 100; constrainToNavMesh: ${this.navMeshEnabled}`);

        console.log(`NavMesh Constraint: ${this.navMeshEnabled}`); // Debug dans la console
      }
    },

    remove: function () {
      window.removeEventListener('keydown', this.toggleNavMesh);
    }
  });
</script>

<script>
  AFRAME.registerComponent('collect-dragon-balls', {
    init: function () {
      this.collectedBalls = 0;
      this.totalBalls = document.querySelectorAll('.collectible').length;
      this.nimbus = document.querySelector('#nimbus'); // Récupération du Nimbus
      this.rig = document.querySelector('#rig'); // Récupération du joueur
      this.onCollect = this.onCollect.bind(this);

      document.querySelectorAll('.collectible').forEach(el => {
        el.addEventListener('click', this.onCollect);
      });

      // Assurer que le Nimbus est caché au départ
      this.nimbus.setAttribute('visible', 'false');

      // Désactiver le vol au démarrage
      this.rig.setAttribute('movement-controls', 'fly: false; acceleration: 100; constrainToNavMesh: true');
    },

    onCollect: function (event) {
      event.target.setAttribute('visible', 'false');
      this.collectedBalls += 1;
      document.querySelector('#collect-text').setAttribute('text', `value: Dragon Balls: ${this.collectedBalls}/7`);

      if (this.collectedBalls === this.totalBalls) {
        this.enableFlyMode();
      }
    },

    enableFlyMode: function () {
      // Activer le mode vol seulement après collecte complète
      this.rig.setAttribute('movement-controls', 'fly: true; acceleration: 100; constrainToNavMesh: false');
      
      // Rendre le Nimbus visible
      this.nimbus.setAttribute('visible', 'true');

      console.log('Fly mode enabled, Nimbus visible');
    }
  });

  // Ajout du composant à la scène
  document.querySelector('a-scene').setAttribute('collect-dragon-balls', '');
</script>




<script>
    document.addEventListener('DOMContentLoaded', function () {
    const video = document.querySelector('#introdb');
    const videoEntity = document.querySelector('#video-entity');
    video.play().catch(error => {
      console.log("Autoplay bloqué, ajout d'un événement click.");
      document.body.addEventListener('click', function () {
        video.play();
      }, { once: true });
    });

    video.addEventListener('play', function () {
      videoEntity.setAttribute('material', 'src', '#introdb');
    });
  });
</script>
<script>
  AFRAME.registerComponent('show-video-on-approach', {
    schema: { distance: { type: 'number', default: 3 } },

    init: function () {
      this.cameraEl = document.querySelector('#camera'); // La caméra
      this.videoEntity = document.querySelector('#video-entity'); // L'entité vidéo
      this.video = document.querySelector('#introdb'); // L'élément vidéo HTML
      this.textEl = this.el; // Élément texte auquel ce composant est attaché
      this.videoVisible = false; // Suivi de l'état de la vidéo

      // On commence en cachant la vidéo
      this.videoEntity.setAttribute('visible', 'false');

      // Vérifier si la vidéo peut être lue
      this.video.addEventListener('play', () => {
        this.videoEntity.setAttribute('material', 'src', '#introdb');
      });

      // Gestion du blocage de l'autoplay
      this.video.play().catch(() => {
        console.log("Autoplay bloqué, ajout d'un événement click.");
        document.body.addEventListener('click', () => this.video.play(), { once: true });
      });
    },

    tick: function () {
      // Récupère la position de la caméra et du texte
      const cameraPosition = new THREE.Vector3();
      this.cameraEl.object3D.getWorldPosition(cameraPosition);

      const textPosition = new THREE.Vector3();
      this.textEl.object3D.getWorldPosition(textPosition);

      // Calcul de la distance entre la caméra et le texte
      const distance = cameraPosition.distanceTo(textPosition);

      // Affichage de la vidéo si l'utilisateur est à moins de la distance définie
      if (distance < this.data.distance && !this.videoVisible) {
        this.videoEntity.setAttribute('visible', 'true');
        this.videoEntity.setAttribute('animation', 'property: opacity; from: 0; to: 1; dur: 500; easing: easeInOutQuad');
        this.video.play();
        this.videoVisible = true;
      }

      // Cacher la vidéo si l'utilisateur s'éloigne
      if (distance >= this.data.distance && this.videoVisible) {
        this.videoEntity.setAttribute('animation', 'property: opacity; from: 1; to: 0; dur: 500; easing: easeInOutQuad');
        setTimeout(() => {
          this.videoEntity.setAttribute('visible', 'false');
          this.video.pause();
        }, 500);
        this.videoVisible = false;
      }
    }
  });
</script>

  </a-scene>
</body>
</html>
